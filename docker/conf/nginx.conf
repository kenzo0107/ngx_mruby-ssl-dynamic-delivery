env REDIS_HOST;

user daemon;
worker_processes auto;
error_log stderr;

events {
    worker_connections 1024;
}

http {
    # HTTPヘッダにnginxのバージョン情報を付加しないようにする
    server_tokens off;

    # クライアントにレスポンスする際にコンテンツがどのようなものか知らせる必要があり
    # MINEタイプと拡張子情報を読み込む必要がる
    include      mime.types;
    default_type application/octet-stream;

    # コンテンツの読込みとクライアントのレスポンス送信にsendfileシステムコールを使用する
    # カーネル空間での処理となるので処理が改善される
    sendfile on;

    # レスポンスヘッダとファイル内容を同時に送信しパケットを最小化する(sendfileを使用している時にのみ有効)
    tcp_nopush on;

    log_format ltsv 'domain:$host\t'
                    'host:$remote_addr\t'
                    'user:$remote_user\t'
                    'time:$time_local\t'
                    'method:$request_method\t'
                    'path:$request_uri\t'
                    'protocol:$server_protocol\t'
                    'status:$status\t'
                    'size:$body_bytes_sent\t'
                    'referer:$http_referer\t'
                    'agent:$http_user_agent\t'
                    'response_time:$request_time\t'
                    'cookie:$http_cookie\t'
                    'set_cookie:$sent_http_set_cookie\t'
                    'upstream_addr:$upstream_addr\t'
                    'upstream_cache_status:$upstream_cache_status\t'
                    'upstream_response_time:$upstream_response_time';

    access_log /usr/local/nginx/logs/access.log ltsv;

    mruby_init_worker /usr/local/nginx/hook/init_worker.rb;
    mruby_exit_worker /usr/local/nginx/hook/exit_worker.rb;

    server {
        listen 80;
        listen [::]:80;
        # ELB到達がHTTPだった場合、HTTPにリダイレクトする
        if ($http_x_forwarded_proto != https) {
            set $to_https  A;
        }
        if ($http_user_agent !~* ELB-HealthChecker) {
            set $to_https  "${to_https}B";
        }
        if ($to_https = AB) {
            return 301 https://$host$request_uri;
        }

        location / {
            if ($request_uri ~ ^/healthcheck) {
                return 200;
            }
        }
    }

    server {
        listen 443 ssl;
        server_name _;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers 'ECDHE+AESGCM:DHE+aRSA+AESGCM:ECDHE+AESCCM:DHE+aRSA+AESCCM:+AES256:ECDHE+CHACHA20:DHE+aRSA+CHACHA20:+DHE:ECDHE+AES128:ECDHE+CAMELLIA128:ECDHE+AES:ECDHE+CAMELLIA:+ECDHE+SHA:DHE+aRSA+AES128:DHE+aRSA+CAMELLIA128:DHE+aRSA+AES:DHE+aRSA+CAMELLIA:+DHE+aRSA+SHA';
        ssl_certificate /etc/ssl/certs/dummy.crt;
        ssl_certificate_key /etc/ssl/certs/dummy.key;

        mruby_ssl_handshake_handler /usr/local/nginx/hook/ssl_handshake_handler.rb cache;

        location / {
            root /usr/local/nginx/html;
            index index.html;
        }
    }
}
